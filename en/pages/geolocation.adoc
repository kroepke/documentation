[[geolocation]]
Geolocation
-----------

Graylog lets you extract and visualize geolocation information from IP
addresses in your logs. Here we will explain how to install and
configure the geolocation resolution, and how to create a map with those
geolocation.

[[setup]]
Setup
~~~~~

The https://github.com/Graylog2/graylog-plugin-map-widget[Graylog Map
Widget] is the plugin providing geolocation capabilities to Graylog. The
plugin is compatible with Graylog 2.0.0 and higher, and it is installed
by default, although **some configuration is still required on your
side**. This section explains how to configure the plugin in detail.

In case you need to reinstall the plugin for some reason, you can find
it inside the Graylog tarball in our
https://www.graylog.org/download/[downloads page]. Follow the
instructions in installing_and_loading_plugins to install it.

[[configure-the-database]]
Configure the database
^^^^^^^^^^^^^^^^^^^^^^

In first place, you need to download a geolocation database. We
currently support *MaxMind City databases* in the **MaxMind DB format**,
as the https://www.maxmind.com/en/geoip2-city[GeoIP2 City Database] or
https://dev.maxmind.com/geoip/geoip2/geolite2/[GeoLite2 City Database]
that MaxMind provides.

The next step is to store the geolocation database in all servers
running Graylog. As an example, if you were using the Graylog OVA, you
could save the database in the `/var/opt/graylog/data` folder, along
with other data used by Graylog. Make sure you grant the right
permissions so the user running Graylog can read the file.

Then you need to configure Graylog to start using the geolocation
database to resolve IPs in your logs. To do that, open Graylog web
interface in your favourite browser, and go to __System ->
Configurations__. You can find the geolocation configuration under the
_Plugins / Geo-Location Processor_ section, as seen in the screenshot.

image:/images/geolocation_1.png[image]

In the configuration modal, you need to check the
Enable geolocation processor, and enter the path to the geolocation
database you use. Once you are all set, click on save to store the
configuration changes.

image:/images/geolocation_2.png[image]

[[configure-the-message-processor]]
Configure the message processor
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The last step before being able to resolve locations from IPs in your
logs, is to activate the GeoIP Resolver processor. In the same _System
-> Configurations_ page, update the configuration in the _Message
Processors Configuration_ section.

image:/images/geolocation_3.png[image]

In that screen, you need to **enable the GeoIP Resolver**, and you must
also **set the GeopIP Resolver as the last message processor to run**,
if you want to be able to resolve geolocation from fields coming from
extractors.

image:/images/geolocation_4.png[image]

That's it, at this point Graylog will start looking for fields
*containing exclusively* an IPv4 or IPv6 address, and extracting their
geolocation into a `<field>_geolocation` field.

**Note**: In case you are not sending structured logs to Graylog, you
can use extractors to store the IPs in your messages into their own
fields. Check out the extractors documentation for more information.

[[verify-the-geolocation-configuration-optional]]
Verify the geolocation configuration (Optional)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

To ensure the geolocation resolution is working as expected, you can do
the following:

1.  Create a TCP Raw/Plaintext input:

image:/images/geolocation_5.png[image]

\2. Send a message only containing an IP to the newly created input. As
an example, we will be using the nc command:
`nc -w0 <graylog_host> 5555 <<< '8.8.8.8'`

1.  Verify that the message contains a `message_geolocation` field:

image:/images/geolocation_6.png[image]

1.  Delete the input if you don't need it any more

In case the message does not contain a `message_geolocation` field,
please check your Graylog server logs, and ensure you followed the steps
in the configure_geolocation section.

[[visualize-geolocations-in-a-map]]
Visualize geolocations in a map
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Graylog can display maps from geolocation stored in any field, as long
as the geo-points are using the `latitude,longitude` format.

[[display-a-map-in-the-search-results-page]]
Display a map in the search results page
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

On any search result page, you can expand the field you want to use to
draw a map in the search sidebar, and click on the _World Map_ link.
That will show a map with all different points stored in that field.

image:/images/geolocation_7.png[image]

[[add-map-to-a-dashboard]]
Add map to a dashboard
^^^^^^^^^^^^^^^^^^^^^^

You can add the map visualization into any dashboards as you do with
other widgets. Once you displayed a map in the search result page, click
on __Add to dashboard__, and select the dashboard where you want to add
the map.

image:/images/geolocation_8.png[image]

image:/images/geolocation_9.png[image]

[[faqs]]
FAQs
~~~~

[[will-graylog-extract-ips-from-all-fields]]
Will Graylog extract IPs from all fields?
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Yes, as long as they contain exclusively an IP address.

[[where-are-the-extracted-geolocations-stored]]
Where are the extracted geolocations stored?
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Extracted geolocations are stored in a new field, named as the original
field, with `_geolocation` appended to it. That is, if the original
field was called `ip_address`, the extracted geolocation will be stored
in the `ip_address_geolocation` field.

[[which-geo-points-format-does-graylog-use-to-store-geolocation-information]]
Which geo-points format does Graylog use to store geolocation
information?
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Graylog stores the geolocation information in the `latitude,longitude`
format.

[[i-have-a-field-in-my-messages-with-geolocation-information-already-can-i-use-it-in-graylog]]
I have a field in my messages with geolocation information already, can
I use it in Graylog?
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Yes, as long as it contains geolocation information in the
`latitude,longitude` format.

[[not-all-fields-containing-ip-addresses-are-resolved.-why-does-this-happen]]
Not all fields containing IP addresses are resolved. Why does this
happen?
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Most likely it is a misconfiguration issue. Please ensure that **the IPs
you want to get geolocation information from are in their own fields**,
and also ensure that *the GeoIP Resolver is enabled, and in the right
order* in the __Message Processors Configuration__, as explained in
configure_message_processor.
